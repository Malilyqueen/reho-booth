<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MaPocket - Vue du Projet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/cdn/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1d3557;
      --secondary-color: #457b9d;
      --accent-color: #ffc300;
      --background-color: #eaf4fb;
      --text-color: #333;
      --border-color: #ddd;
      --card-bg: #fff;
      --success-color: #4caf50;
      --danger-color: #f44336;
    }

    body {
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .back-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 15px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
    }

    h1 {
      color: var(--primary-color);
      margin: 0;
      font-size: 1.8rem;
    }

    .project-overview {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .project-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .detail-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .budget-progress {
      margin-top: 20px;
    }

    .progress-bar {
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--accent-color);
      width: 0%; /* Will be updated by JS */
      transition: width 0.5s ease-in-out;
    }

    .categories-container {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .category {
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    .category-header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }

    .subcategory {
      border-bottom: 1px solid var(--border-color);
      padding: 0 15px;
    }

    .subcategory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      font-weight: 500;
      color: var(--secondary-color);
    }

    .subcategory-title {
      margin: 0;
      font-size: 1.1rem;
    }

    .expense-lines {
      padding: 0 0 10px 20px;
    }

    .expense-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 10px;
    }

    .line-actions {
      display: flex;
      gap: 5px;
    }

    .edit-btn, .delete-btn, .add-btn {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2px;
      border-radius: 3px;
      font-size: 0.9rem;
    }

    .edit-btn {
      color: var(--secondary-color);
    }

    .delete-btn {
      color: var(--danger-color);
    }

    .add-btn {
      color: var(--success-color);
      margin-top: 5px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .add-btn i {
      font-size: 0.8rem;
    }

    .expense-name, .expense-amount {
      padding: 5px 8px;
      border: 1px solid transparent;
      border-radius: 4px;
      min-width: 100px;
      transition: border-color 0.3s;
    }

    .expense-name {
      flex-grow: 1;
    }

    .expense-amount {
      text-align: right;
      min-width: 100px;
      font-weight: 500;
    }

    .edit-mode .expense-name, .edit-mode .expense-amount {
      border-color: var(--border-color);
      background-color: #f9f9f9;
    }

    .edit-mode .expense-name:focus, .edit-mode .expense-amount:focus {
      border-color: var(--secondary-color);
      outline: none;
    }

    .expense-line input {
      padding: 5px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: white;
    }

    .expense-line input:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 2px rgba(69, 123, 157, 0.2);
    }

    .expense-line input[type="number"] {
      text-align: right;
      width: 100px;
    }

    .expense-line input[type="text"] {
      flex-grow: 1;
    }

    .add-category-btn, .add-subcategory-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 15px;
      cursor: pointer;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }

    .add-subcategory-btn {
      background-color: var(--secondary-color);
      margin-left: 15px;
      margin-bottom: 15px;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: var(--success-color);
      color: white;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transform: translateX(150%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      background-color: var(--danger-color);
    }
    
    /* Styles pour les éléments en mode édition */
    .edit-mode .expense-line-name, 
    .edit-mode .expense-line-amount,
    .edit-mode .subcategory-name,
    .edit-mode .category-name {
      border: 1px solid #ddd;
      padding: 5px 8px;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    
    .edit-mode .btn-delete-line,
    .edit-mode .btn-add-line,
    .edit-mode .btn-add-subcategory {
      display: inline-flex;
    }
    
    .btn-delete-line,
    .btn-add-line,
    .btn-add-subcategory,
    .btn-add-category {
      display: none;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 0.9rem;
    }
    
    .btn-delete-line {
      color: var(--danger-color);
    }
    
    .btn-add-line, 
    .btn-add-subcategory,
    .btn-add-category {
      color: var(--success-color);
      margin-top: 8px;
      padding: 5px 10px;
      border: 1px solid;
      border-radius: 4px;
    }
    
    /* Notification style */
    .notification-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .notification {
      background-color: #4caf50;
      color: white;
      padding: 12px 20px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transform: translateX(120%);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background-color: #f44336;
    }
    
    .notification i {
      font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
      .project-details {
        grid-template-columns: 1fr;
      }
      
      .category-header, .subcategory-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .expense-line {
        flex-wrap: wrap;
      }
      
      .expense-name, .expense-amount {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> Retour au tableau de bord
      </a>
      <div class="actions">
        <button id="editModeToggle" class="btn btn-primary">
          <i class="fas fa-edit"></i> Modifier
        </button>
        <button id="completeProjectBtn" class="btn btn-success">
          <i class="fas fa-check"></i> Terminer
        </button>
        <button id="archiveProjectBtn" class="btn btn-danger">
          <i class="fas fa-archive"></i> Archiver
        </button>
        <button id="switchInterfaceBtn" class="btn btn-secondary" style="margin-left: 5px; background-color: #6c757d;">
          <i class="fas fa-exchange-alt"></i> Interface classique
        </button>
        <button id="switchModernInterfaceBtn" class="btn btn-secondary" style="margin-left: 5px; background-color: #6366f1;">
          <i class="fas fa-paint-brush"></i> Interface moderne
        </button>
      </div>
    </header>

    <h1 id="projectTitle">Chargement du projet...</h1>

    <div class="project-overview">
      <div class="project-details">
        <div class="detail-item">
          <span class="detail-label">Date</span>
          <span id="projectDate" class="detail-value">--/--/----</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Type</span>
          <span id="projectType" class="detail-value">--</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Budget initial</span>
          <span id="initialBudget" class="detail-value">0,00 €</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Budget utilisé</span>
          <span id="totalBudget" class="detail-value">0,00 €</span>
        </div>
      </div>
      <div class="budget-progress">
        <div class="detail-label">Progression du budget: <span id="budgetPercentage">0%</span></div>
        <div class="progress-bar">
          <div id="progressBar" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div class="categories-container" id="categoriesContainer">
      <!-- Les catégories seront générées ici par JavaScript -->
      <div class="loading">Chargement des catégories...</div>
    </div>

    <button id="addCategoryBtn" class="add-category-btn" style="display:none;">
      <i class="fas fa-plus"></i> Ajouter une catégorie
    </button>
  </div>

  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notificationText">Modifications enregistrées</span>
  </div>

  <script>
    // Définition des variables globales
    let currentProject = null;
    let isEditMode = false;
    let currencySymbol = '€';
    
    // Fonction pour formater les montants avec 2 décimales et le symbole monétaire
    function formatAmount(amount) {
      if (typeof amount === 'string') {
        amount = parseFloat(amount.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
      }
      return amount.toFixed(2).replace('.', ',');
    }
    
    // Fonction pour formater les montants avec le symbole de devise
    function formatCurrency(amount) {
      if (typeof amount === 'string') {
        amount = parseFloat(amount.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
      }
      return currencySymbol + ' ' + formatAmount(amount);
    }
    
    // Fonction pour recalculer tous les montants (ligne -> sous-catégorie -> catégorie -> total)
    function recalculateAllAmounts() {
      console.log("🔄 Recalcul en cascade lancé");
      
      let projectTotal = 0;
      
      // Pour chaque catégorie
      document.querySelectorAll('.category').forEach(categoryEl => {
        let categoryTotal = 0;
        
        // Pour chaque sous-catégorie dans cette catégorie
        categoryEl.querySelectorAll('.subcategory').forEach(subEl => {
          let subTotal = 0;
          
          // Pour chaque ligne de dépense dans cette sous-catégorie
          subEl.querySelectorAll('.expense-line').forEach(lineEl => {
            // Récupérer le montant (peut être un input ou un span selon le mode)
            const amountEl = lineEl.querySelector('.expense-amount');
            let amount = 0;
            
            if (amountEl) {
              if (amountEl.tagName === 'INPUT') {
                // Mode édition - lire la valeur du champ input
                amount = parseFloat(amountEl.value) || 0;
              } else {
                // Mode lecture - extraire la valeur numérique du texte
                amount = parseFloat(amountEl.textContent.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
              }
              subTotal += amount;
            }
          });
          
          // Mettre à jour le montant de la sous-catégorie
          const subAmountEl = subEl.querySelector('.subcategory-amount');
          if (subAmountEl) {
            subAmountEl.textContent = formatCurrency(subTotal);
          }
          
          categoryTotal += subTotal;
        });
        
        // Mettre à jour le montant de la catégorie
        const catAmountEl = categoryEl.querySelector('.category-amount');
        if (catAmountEl) {
          catAmountEl.textContent = formatCurrency(categoryTotal);
        }
        
        projectTotal += categoryTotal;
      });
      
      // Mettre à jour le budget total du projet
      const totalBudgetEl = document.getElementById('totalBudget');
      if (totalBudgetEl) {
        totalBudgetEl.textContent = formatCurrency(projectTotal);
      }
      
      // Mettre à jour la barre de progression
      updateProgressBar(projectTotal);
      
      console.log(`✅ Recalcul terminé : total = ${projectTotal}`);
      
      return projectTotal;
    }
    
    // Fonction pour mettre à jour la barre de progression
    function updateProgressBar(currentBudget) {
      const initialBudget = parseFloat(document.getElementById('initialBudget').textContent.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
      const percentage = initialBudget > 0 ? Math.min(Math.round((currentBudget / initialBudget) * 100), 100) : 0;
      
      document.getElementById('budgetPercentage').textContent = percentage + '%';
      document.getElementById('progressBar').style.width = percentage + '%';
      
      // Changer la couleur selon le pourcentage
      const progressBar = document.getElementById('progressBar');
      if (percentage > 90) {
        progressBar.style.backgroundColor = '#f44336'; // Rouge si > 90%
      } else if (percentage > 75) {
        progressBar.style.backgroundColor = '#ff9800'; // Orange si > 75%
      } else {
        progressBar.style.backgroundColor = '#4caf50'; // Vert sinon
      }
    }
    
    // Fonction pour basculer en mode édition
    function toggleEditMode() {
      const body = document.body;
      const button = document.getElementById('editModeToggle');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      
      isEditMode = !body.classList.contains('edit-mode');
      
      if (isEditMode) {
        body.classList.add('edit-mode');
        button.innerHTML = '<i class="fas fa-save"></i> Terminer';
        addCategoryBtn.style.display = 'inline-flex';
        enableEditMode();
      } else {
        body.classList.remove('edit-mode');
        button.innerHTML = '<i class="fas fa-edit"></i> Modifier';
        addCategoryBtn.style.display = 'none';
        disableEditMode();
        saveProjectChanges();
        showNotification('Modifications enregistrées avec succès');
      }
    }
    
    // Fonction pour activer le mode édition
    function enableEditMode() {
      // Rendre les noms et montants des lignes éditables
      document.querySelectorAll('.expense-line').forEach(line => {
        const nameEl = line.querySelector('.expense-name');
        const amountEl = line.querySelector('.expense-amount');
        
        if (nameEl && nameEl.tagName !== 'INPUT') {
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.className = 'expense-name';
          nameInput.value = nameEl.textContent.trim();
          nameInput.addEventListener('input', debounce(recalculateAllAmounts, 300));
          nameEl.parentNode.replaceChild(nameInput, nameEl);
        }
        
        if (amountEl && amountEl.tagName !== 'INPUT') {
          const amountValue = parseFloat(amountEl.textContent.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
          const amountInput = document.createElement('input');
          amountInput.type = 'number';
          amountInput.className = 'expense-amount';
          amountInput.min = '0';
          amountInput.step = '0.01';
          amountInput.value = amountValue.toFixed(2);
          amountInput.addEventListener('input', debounce(recalculateAllAmounts, 300));
          amountEl.parentNode.replaceChild(amountInput, amountEl);
        }
        
        // Ajouter un bouton de suppression s'il n'existe pas
        if (!line.querySelector('.btn-delete-line')) {
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn-delete-line';
          deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
          deleteBtn.addEventListener('click', function() {
            if (confirm('Voulez-vous vraiment supprimer cette ligne ?')) {
              line.remove();
              recalculateAllAmounts();
              saveProjectChanges();
            }
          });
          line.appendChild(deleteBtn);
        }
      });
      
      // Ajouter les boutons "Ajouter une ligne" à chaque sous-catégorie
      document.querySelectorAll('.subcategory').forEach(subcat => {
        if (!subcat.querySelector('.btn-add-line')) {
          const addBtn = document.createElement('button');
          addBtn.className = 'btn-add-line';
          addBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter une dépense';
          addBtn.addEventListener('click', function() {
            addNewExpenseLine(subcat, addBtn);
          });
          subcat.appendChild(addBtn);
        }
        
        // Rendre visible le bouton
        const addBtn = subcat.querySelector('.btn-add-line');
        if (addBtn) {
          addBtn.style.display = 'inline-flex';
        }
      });
      
      // Ajouter les boutons "Ajouter une sous-catégorie" à chaque catégorie
      document.querySelectorAll('.category').forEach(cat => {
        if (!cat.querySelector('.btn-add-subcategory')) {
          const addBtn = document.createElement('button');
          addBtn.className = 'btn-add-subcategory';
          addBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter une sous-catégorie';
          addBtn.addEventListener('click', function() {
            addNewSubcategory(cat);
          });
          cat.appendChild(addBtn);
        }
        
        // Rendre visible le bouton
        const addBtn = cat.querySelector('.btn-add-subcategory');
        if (addBtn) {
          addBtn.style.display = 'inline-flex';
        }
      });
      
      // Afficher le bouton pour ajouter une catégorie
      document.getElementById('addCategoryBtn').style.display = 'inline-flex';
    }
    
    // Fonction pour désactiver le mode édition
    function disableEditMode() {
      // Convertir les inputs en texte normal
      document.querySelectorAll('.expense-name').forEach(input => {
        if (input.tagName === 'INPUT') {
          const span = document.createElement('span');
          span.className = 'expense-name';
          span.textContent = input.value;
          input.parentNode.replaceChild(span, input);
        }
      });
      
      document.querySelectorAll('.expense-amount').forEach(input => {
        if (input.tagName === 'INPUT') {
          const span = document.createElement('span');
          span.className = 'expense-amount';
          span.textContent = formatCurrency(parseFloat(input.value) || 0);
          input.parentNode.replaceChild(span, input);
        }
      });
      
      // Cacher les boutons d'ajout et de suppression
      document.querySelectorAll('.btn-add-line, .btn-add-subcategory, .btn-delete-line').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // Cacher le bouton pour ajouter une catégorie
      document.getElementById('addCategoryBtn').style.display = 'none';
    }
    
    // Fonction pour ajouter une nouvelle ligne de dépense
    function addNewExpenseLine(subcategoryEl, beforeElement) {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'expense-line';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.className = 'expense-name';
      nameInput.placeholder = 'Nouvelle dépense';
      nameInput.value = '';
      
      const amountInput = document.createElement('input');
      amountInput.type = 'number';
      amountInput.className = 'expense-amount';
      amountInput.min = '0';
      amountInput.step = '0.01';
      amountInput.value = '0.00';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-delete-line';
      deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
      deleteBtn.addEventListener('click', function() {
        if (confirm('Voulez-vous vraiment supprimer cette ligne ?')) {
          lineDiv.remove();
          recalculateAllAmounts();
          saveProjectChanges();
        }
      });
      
      // Ajouter les écouteurs d'événements
      nameInput.addEventListener('change', function() {
        saveProjectChanges();
      });
      
      amountInput.addEventListener('input', function() {
        debounce(recalculateAllAmounts, 300)();
      });
      
      // Assembler la ligne
      lineDiv.appendChild(nameInput);
      lineDiv.appendChild(amountInput);
      lineDiv.appendChild(deleteBtn);
      
      // Insérer avant le bouton "Ajouter une ligne"
      const linesContainer = subcategoryEl.querySelector('.expense-lines') || subcategoryEl;
      if (beforeElement) {
        linesContainer.insertBefore(lineDiv, beforeElement);
      } else {
        linesContainer.appendChild(lineDiv);
      }
      
      // Donner le focus au champ de nom
      nameInput.focus();
      
      // Recalculer les montants
      recalculateAllAmounts();
    }
    
    // Fonction pour ajouter une nouvelle sous-catégorie
    function addNewSubcategory(categoryEl) {
      const subcatName = prompt('Nom de la nouvelle sous-catégorie:');
      if (!subcatName || subcatName.trim() === '') return;
      
      const subcatDiv = document.createElement('div');
      subcatDiv.className = 'subcategory';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'subcategory-header';
      
      const title = document.createElement('h4');
      title.className = 'subcategory-title';
      title.innerHTML = subcatName + ' <span class="subcategory-amount">' + formatCurrency(0) + '</span>';
      
      headerDiv.appendChild(title);
      subcatDiv.appendChild(headerDiv);
      
      const linesDiv = document.createElement('div');
      linesDiv.className = 'expense-lines';
      subcatDiv.appendChild(linesDiv);
      
      const addLineBtn = document.createElement('button');
      addLineBtn.className = 'btn-add-line';
      addLineBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter une dépense';
      addLineBtn.addEventListener('click', function() {
        addNewExpenseLine(subcatDiv);
      });
      
      subcatDiv.appendChild(addLineBtn);
      
      // Ajouter avant le bouton "Ajouter une sous-catégorie"
      const addSubcatBtn = categoryEl.querySelector('.btn-add-subcategory');
      if (addSubcatBtn) {
        categoryEl.insertBefore(subcatDiv, addSubcatBtn);
      } else {
        categoryEl.appendChild(subcatDiv);
      }
      
      // Ajouter une ligne vide
      addNewExpenseLine(subcatDiv);
      
      // Recalculer et sauvegarder
      recalculateAllAmounts();
      saveProjectChanges();
      
      return subcatDiv;
    }
    
    // Fonction pour ajouter une nouvelle catégorie
    function addNewCategory() {
      const catName = prompt('Nom de la nouvelle catégorie:');
      if (!catName || catName.trim() === '') return;
      
      const catDiv = document.createElement('div');
      catDiv.className = 'category';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'category-header';
      headerDiv.innerHTML = catName + ' <span class="category-amount">' + formatCurrency(0) + '</span>';
      
      catDiv.appendChild(headerDiv);
      
      // Ajouter le bouton pour ajouter des sous-catégories
      const addSubcatBtn = document.createElement('button');
      addSubcatBtn.className = 'btn-add-subcategory';
      addSubcatBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter une sous-catégorie';
      addSubcatBtn.addEventListener('click', function() {
        addNewSubcategory(catDiv);
      });
      
      catDiv.appendChild(addSubcatBtn);
      
      // Ajouter la catégorie au conteneur
      const container = document.getElementById('categoriesContainer');
      container.appendChild(catDiv);
      
      // Ajouter une sous-catégorie par défaut
      const subcatDiv = addNewSubcategory(catDiv);
      
      // Recalculer et sauvegarder
      recalculateAllAmounts();
      saveProjectChanges();
      
      return catDiv;
    }
    
    // Fonction pour sauvegarder les modifications du projet
    function saveProjectChanges() {
      console.log('Sauvegarde des modifications du projet...');
      
      if (!currentProject) return;
      
      // Récupérer tous les projets du localStorage
      let allProjects = [];
      try {
        allProjects = JSON.parse(localStorage.getItem('savedProjects') || '[]');
      } catch (error) {
        console.error('Erreur lors de la récupération des projets:', error);
        return;
      }
      
      // Trouver l'index du projet actuel
      const projectId = currentProject.id;
      const projectIndex = allProjects.findIndex(p => p.id === projectId);
      
      if (projectIndex === -1) {
        console.error('Projet non trouvé dans la liste');
        return;
      }
      
      // Récupérer le projet actuel
      const project = allProjects[projectIndex];
      
      // Mettre à jour les données du projet
      project.categories = collectCategoriesData();
      
      // Calculer et mettre à jour le budget total
      let totalBudget = 0;
      project.categories.forEach(category => {
        if (category.amount) {
          const amount = parseFloat(category.amount.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
          totalBudget += amount;
        }
      });
      
      project.totalBudget = formatCurrency(totalBudget);
      
      // Mettre à jour le projet dans la liste
      allProjects[projectIndex] = project;
      
      // Sauvegarder dans le localStorage
      localStorage.setItem('savedProjects', JSON.stringify(allProjects));
      
      // Mettre à jour le projet courant
      localStorage.setItem('currentProject', JSON.stringify(project));
      currentProject = project;
      
      console.log('Projet sauvegardé avec succès');
      
      // Mettre à jour l'affichage
      updateProjectInfo();
      updateProgressBar(totalBudget);
      
      return true;
    }
    
    // Fonction pour collecter les données des catégories depuis le DOM
    function collectCategoriesData() {
      const categories = [];
      
      document.querySelectorAll('.category').forEach(catEl => {
        const headerEl = catEl.querySelector('.category-header');
        if (!headerEl) return;
        
        const catName = headerEl.childNodes[0].nodeValue.trim();
        const catAmountEl = headerEl.querySelector('.category-amount');
        const catAmount = catAmountEl ? catAmountEl.textContent : formatCurrency(0);
        
        const subcategories = [];
        
        catEl.querySelectorAll('.subcategory').forEach(subEl => {
          const headerEl = subEl.querySelector('.subcategory-header');
          if (!headerEl) return;
          
          let subName = '';
          let subAmount = formatCurrency(0);
          
          const titleEl = headerEl.querySelector('.subcategory-title');
          if (titleEl) {
            const text = titleEl.innerHTML;
            subName = text.split('<span')[0].trim();
            const amountEl = titleEl.querySelector('.subcategory-amount');
            if (amountEl) {
              subAmount = amountEl.textContent;
            }
          } else {
            // Pour la compatibilité avec la structure alternative
            subName = headerEl.childNodes[0].nodeValue.trim();
            const amountEl = headerEl.querySelector('.subcategory-amount');
            if (amountEl) {
              subAmount = amountEl.textContent;
            }
          }
          
          const lines = [];
          
          subEl.querySelectorAll('.expense-line').forEach(lineEl => {
            const nameEl = lineEl.querySelector('.expense-name');
            const amountEl = lineEl.querySelector('.expense-amount');
            
            if (!nameEl || !amountEl) return;
            
            let lineName = '';
            let lineAmount = '';
            
            // Récupérer les valeurs selon le type d'élément (input ou span)
            if (nameEl.tagName === 'INPUT') {
              lineName = nameEl.value.trim();
            } else {
              lineName = nameEl.textContent.trim();
            }
            
            if (amountEl.tagName === 'INPUT') {
              const numVal = parseFloat(amountEl.value) || 0;
              lineAmount = formatCurrency(numVal);
            } else {
              lineAmount = amountEl.textContent;
            }
            
            if (lineName.trim() !== '') {
              lines.push({
                name: lineName,
                amount: lineAmount
              });
            }
          });
          
          if (subName.trim() !== '') {
            subcategories.push({
              name: subName,
              amount: subAmount,
              lines: lines
            });
          }
        });
        
        if (catName.trim() !== '') {
          categories.push({
            name: catName,
            amount: catAmount,
            subcategories: subcategories
          });
        }
      });
      
      return categories;
    }
    
    // Fonction pour charger et afficher les données du projet
    function loadAndDisplayProject() {
      const projectId = localStorage.getItem('viewProjectId');
      if (!projectId) {
        showNotification('Aucun projet sélectionné', true);
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        return;
      }
      
      try {
        const projects = JSON.parse(localStorage.getItem('savedProjects') || '[]');
        currentProject = projects.find(p => p.id === projectId);
        
        if (!currentProject) {
          showNotification('Projet non trouvé', true);
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          return;
        }
        
        // Récupérer le symbole de la devise
        try {
          const userPrefs = JSON.parse(localStorage.getItem('userPreferences')) || {};
          const currency = userPrefs.currency || 'EUR';
          const currencies = JSON.parse(localStorage.getItem('currencies')) || {};
          currencySymbol = currencies[currency]?.symbol || '€';
        } catch (e) {
          console.error('Erreur lors de la récupération de la devise:', e);
          currencySymbol = '€';
        }
        
        // Mettre à jour les informations du projet
        updateProjectInfo();
        
        // Générer les catégories
        const categoriesContainer = document.getElementById('categoriesContainer');
        categoriesContainer.innerHTML = ''; // Vider le conteneur
        
        if (currentProject.categories && currentProject.categories.length > 0) {
          currentProject.categories.forEach(category => {
            const catDiv = document.createElement('div');
            catDiv.className = 'category';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'category-header';
            headerDiv.innerHTML = category.name + ' <span class="category-amount">' + 
                                 (category.amount || formatCurrency(0)) + '</span>';
            
            catDiv.appendChild(headerDiv);
            
            // Ajouter les sous-catégories
            if (category.subcategories && category.subcategories.length > 0) {
              category.subcategories.forEach(subcategory => {
                const subDiv = document.createElement('div');
                subDiv.className = 'subcategory';
                
                const subHeaderDiv = document.createElement('div');
                subHeaderDiv.className = 'subcategory-header';
                
                const title = document.createElement('h4');
                title.className = 'subcategory-title';
                title.innerHTML = subcategory.name + ' <span class="subcategory-amount">' + 
                                (subcategory.amount || formatCurrency(0)) + '</span>';
                
                subHeaderDiv.appendChild(title);
                subDiv.appendChild(subHeaderDiv);
                
                const linesDiv = document.createElement('div');
                linesDiv.className = 'expense-lines';
                
                // Ajouter les lignes de dépenses
                if (subcategory.lines && subcategory.lines.length > 0) {
                  subcategory.lines.forEach(line => {
                    if (!line.name && !line.amount) return; // Skip empty lines
                    
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'expense-line';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'expense-name';
                    nameSpan.textContent = line.name || '';
                    
                    const amountSpan = document.createElement('span');
                    amountSpan.className = 'expense-amount';
                    amountSpan.textContent = line.amount || formatCurrency(0);
                    
                    lineDiv.appendChild(nameSpan);
                    lineDiv.appendChild(amountSpan);
                    
                    linesDiv.appendChild(lineDiv);
                  });
                }
                
                subDiv.appendChild(linesDiv);
                catDiv.appendChild(subDiv);
              });
            }
            
            // Ajouter le bouton pour ajouter des sous-catégories (caché par défaut)
            const addSubcatBtn = document.createElement('button');
            addSubcatBtn.className = 'btn-add-subcategory';
            addSubcatBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter une sous-catégorie';
            addSubcatBtn.style.display = 'none';
            addSubcatBtn.addEventListener('click', function() {
              addNewSubcategory(catDiv);
            });
            
            catDiv.appendChild(addSubcatBtn);
            categoriesContainer.appendChild(catDiv);
          });
        } else {
          categoriesContainer.innerHTML = '<p>Aucune catégorie trouvée pour ce projet.</p>';
        }
        
        // Ajouter le bouton pour ajouter des catégories
        const addCatBtn = document.getElementById('addCategoryBtn');
        addCatBtn.addEventListener('click', addNewCategory);
        
        // Initialiser la barre de progression
        const totalBudget = currentProject.totalBudget ? 
          parseFloat(currentProject.totalBudget.replace(/[^\d.,]/g, '').replace(',', '.')) || 0 : 0;
        updateProgressBar(totalBudget);
        
        console.log('Projet chargé avec succès:', currentProject.projectName);
      } catch (error) {
        console.error('Erreur lors du chargement du projet:', error);
        showNotification('Erreur lors du chargement du projet', true);
      }
    }
    
    // Fonction pour mettre à jour les informations du projet
    function updateProjectInfo() {
      if (!currentProject) return;
      
      document.getElementById('projectTitle').textContent = currentProject.projectName || 'Projet sans nom';
      document.getElementById('projectDate').textContent = currentProject.projectDate || '--/--/----';
      document.getElementById('projectType').textContent = currentProject.template || 'Projet personnalisé';
      document.getElementById('initialBudget').textContent = currentProject.budgetInitial || formatCurrency(0);
      document.getElementById('totalBudget').textContent = currentProject.totalBudget || formatCurrency(0);
      
      // Mettre à jour la barre de progression
      const totalBudget = parseFloat((currentProject.totalBudget || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
      const initialBudget = parseFloat((currentProject.budgetInitial || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
      
      const percentage = initialBudget > 0 ? Math.min(Math.round((totalBudget / initialBudget) * 100), 100) : 0;
      document.getElementById('budgetPercentage').textContent = percentage + '%';
      document.getElementById('progressBar').style.width = percentage + '%';
    }
    
    // Fonction pour afficher une notification
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      const text = document.getElementById('notificationText');
      
      text.textContent = message;
      notification.className = isError ? 'notification error show' : 'notification show';
      
      setTimeout(() => {
        notification.className = isError ? 'notification error' : 'notification';
      }, 3000);
    }
    
    // Fonction debounce pour limiter les appels rapprochés
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function() {
          func.apply(context, args);
        }, wait);
      };
    }
    
    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', function() {
      // Charger et afficher le projet
      loadAndDisplayProject();
      
      // Ajouter les événements aux boutons
      document.getElementById('editModeToggle').addEventListener('click', toggleEditMode);
      
      // Bouton pour terminer le projet
      document.getElementById('completeProjectBtn').addEventListener('click', function() {
        if (!currentProject) return;
        
        if (confirm('Voulez-vous marquer ce projet comme terminé ?')) {
          // Récupérer tous les projets
          let allProjects = JSON.parse(localStorage.getItem('savedProjects') || '[]');
          const projectIndex = allProjects.findIndex(p => p.id === currentProject.id);
          
          if (projectIndex !== -1) {
            allProjects[projectIndex].projectStatus = 'Terminé';
            localStorage.setItem('savedProjects', JSON.stringify(allProjects));
            currentProject = allProjects[projectIndex];
            
            showNotification('Projet marqué comme terminé');
            
            // Mettre à jour l'affichage
            document.getElementById('projectTitle').innerHTML = currentProject.projectName + ' <span class="status-badge completed">Terminé</span>';
          }
        }
      });
      
      // Bouton pour archiver le projet
      document.getElementById('archiveProjectBtn').addEventListener('click', function() {
        if (!currentProject) return;
        
        if (confirm('Voulez-vous archiver ce projet ? Il sera déplacé dans vos archives.')) {
          // Récupérer tous les projets
          let allProjects = JSON.parse(localStorage.getItem('savedProjects') || '[]');
          const projectIndex = allProjects.findIndex(p => p.id === currentProject.id);
          
          if (projectIndex !== -1) {
            allProjects[projectIndex].archived = true;
            localStorage.setItem('savedProjects', JSON.stringify(allProjects));
            
            showNotification('Projet archivé avec succès');
            
            // Rediriger vers la page d'accueil après un court délai
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 1500);
          }
        }
      });
      
      // Bouton de retour
      document.querySelector('.back-btn').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'index.html';
      });
      
      // Bouton pour basculer vers l'interface classique
      document.getElementById('switchInterfaceBtn').addEventListener('click', function() {
        if (currentProject) {
          // Sauvegarder les changements avant de changer d'interface
          if (isEditMode) {
            // Si en mode édition, désactiver et sauvegarder avant de rediriger
            disableEditMode();
            saveProjectChanges();
          }
          
          // Rediriger vers l'interface classique
          localStorage.setItem('useClassicInterface', 'true');
          window.location.href = 'projet-vue.html';
        }
      });
      
      // Bouton pour basculer vers l'interface moderne
      document.getElementById('switchModernInterfaceBtn').addEventListener('click', function() {
        if (currentProject) {
          // Sauvegarder les changements avant de changer d'interface
          if (isEditMode) {
            // Si en mode édition, désactiver et sauvegarder avant de rediriger
            disableEditMode();
            saveProjectChanges();
          }
          
          // Sauvegarder l'ID du projet actif
          localStorage.setItem('lastActiveProject', currentProject.id);
          
          // Rediriger vers l'interface moderne avec l'ID du projet
          localStorage.setItem('useModernInterface', 'true');
          window.location.href = 'projet-vue-modern.html?id=' + currentProject.id;
        }
      });
    });
    
    // Fonction pour revenir au tableau de bord
    function backToDashboard() {
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>